<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flasher HomeSend</title>
<style>
  body {
    font-family: sans-serif;
    background: #121212;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    padding: 20px;
  }
  h2 { margin-bottom: 20px; }
  label { display: block; margin-top: 15px; }
  select, input[type="text"], input[type="number"] {
    padding: 10px;
    font-size: 1em;
    margin-top: 5px;
    width: 220px;
  }
  button {
    margin-top: 20px;
    padding: 10px 20px;
    font-size: 1em;
    cursor: pointer;
    background: #1f6feb;
    border: none;
    color: white;
    border-radius: 5px;
  }
  #status, #activationStatus {
    margin-top: 20px;
    min-height: 20px;
  }
</style>
</head>
<body>
<h2>Flasher HomeSend</h2>

<div id="page-content" style="display:none;">
  <!-- IR Code Section -->
  <label for="btn">Choisir Button:</label>
  <select id="btn">
    <option value="tv_pwr">TV Power</option>
    <option value="tv_chup">TV Channel Up</option>
    <option value="tv_chdn">TV Channel Down</option>
    <option value="tv_mute">TV Mute</option>
  </select>

  <label for="code">Entrer Code IR:</label>
  <input type="text" id="code" placeholder="Code IR ici">
  <button onclick="uploadCode()">Send IR</button>
  <div id="status"></div>

  <hr style="margin:30px 0; width:80%; border:1px solid #444;">

  <!-- Activation Section -->
  <label for="activationCode">Entrer code Activation:</label>
  <input type="number" id="activationCode" min="0" max="2000" placeholder="Code Activation ici">
  <button onclick="sendActivation()">Confirmer</button>
  <div id="activationStatus"></div>
</div>

<script>
window.onload = function() {
  const correctKey = "1111"; // Security key
  let userKey = prompt("Entrer code securite pour acceder:");

  if (userKey === null || userKey !== correctKey) {
    alert("Code incorrect! Access refuse.");
    document.body.innerHTML = "<h2 style='color:red;'>Access denied.</h2>";
    return;
  }

  document.getElementById('page-content').style.display = 'block';
};

// Upload IR Code
function uploadCode() {
  const btn = document.getElementById('btn').value;
  let code = document.getElementById('code').value.trim().toUpperCase();

  if (!code) { alert("Entre un code valide!"); return; }
  if (code.startsWith("0X")) code = code.substring(2);

  const hexRegex = /^[0-9A-F]{8}$/;
  if (!hexRegex.test(code)) { alert("Code doit etre 8 chiffre!"); return; }

  const statusDiv = document.getElementById('status');
  const sendButton = document.querySelector('button');
  statusDiv.innerText = "Flashing...";
  sendButton.disabled = true;

  fetch(`http://192.168.4.1/storecode?btn=${encodeURIComponent(btn)}&code=${encodeURIComponent(code)}&key=${encodeURIComponent(correctKey)}`)
    .then(resp => { if (!resp.ok) throw new Error("HTTP error " + resp.status); return resp.text(); })
    .then(text => { statusDiv.innerText = text; document.getElementById('code').value = ''; })
    .catch(err => { statusDiv.innerText = "Error: " + err; })
    .finally(() => { sendButton.disabled = false; });
}

// Send Activation Code
function sendActivation() {
  let code = parseInt(document.getElementById('activationCode').value, 10);
  const statusDiv = document.getElementById('activationStatus');

  if (isNaN(code) || code < 0 || code > 2000) {
    alert("Code doit etre entre < 2000!");
    return;
  }

  const sendButton = document.querySelectorAll('button')[1]; // second button
  statusDiv.innerText = "Sending...";
  sendButton.disabled = true;

  fetch(`http://192.168.4.1/activation?code=${code}`)
    .then(resp => { if (!resp.ok) throw new Error("HTTP error " + resp.status); return resp.text(); })
    .then(text => { statusDiv.innerText = text; document.getElementById('activationCode').value = ''; })
    .catch(err => { statusDiv.innerText = "Error: " + err; })
    .finally(() => { sendButton.disabled = false; });
}
</script>
</body>
</html>
